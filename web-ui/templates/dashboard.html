{% extends "base.html" %}

{% block title %}Dashboard - DCRP Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">
        <i class="bi bi-speedometer2 me-2"></i>Route Dashboard
    </h1>
</div>

<!-- Dashboard Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                            <i class="bi bi-list-ul text-primary fs-4"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ routes | length }}</h3>
                    <p class="text-muted small mb-0">Active Routes</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="bi bi-robot text-success fs-4"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ routes | selectattr('source', 'equalto', 'monitor') | list | length }}</h3>
                    <p class="text-muted small mb-0">Auto Routes</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3">
                            <i class="bi bi-person-gear text-info fs-4"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ routes | rejectattr('source', 'equalto', 'monitor') | list | length }}</h3>
                    <p class="text-muted small mb-0">Manual Routes</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="rounded-circle bg-{{ health.status | status_badge }} bg-opacity-10 p-3">
                            <i class="bi bi-heart-pulse text-{{ health.status | status_badge }} fs-4"></i>
                        </div>
                    </div>
                    <h6 class="mb-1">{{ health.status | title }}</h6>
                    <p class="text-muted small mb-0">System Health</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Health Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-heart-pulse me-2"></i>System Status
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshHealth()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-{{ health.status | status_badge }} me-2">
                                <i class="bi bi-circle-fill"></i>
                            </span>
                            <div>
                                <div class="fw-semibold">API Server</div>
                                <small class="text-muted">{{ health.status | title }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="text-muted small">Caddy Admin</div>
                        <code class="small">{{ health.caddy_admin_url or 'N/A' }}</code>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="text-muted small">Server</div>
                        <code class="small">{{ health.server or 'N/A' }}</code>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="text-muted small">Version</div>
                        <code class="small">{{ health.version or 'N/A' }}</code>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6 col-lg-4">
                        <div class="text-muted small">DNS Resolver</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-hdd-network me-1 text-info" title="System DNS Resolver"></i>
                            <code class="small text-info">{{ health.dns_resolver or 'System Default' }}</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Routes Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="bi bi-list-ul me-2"></i>Active Routes
            <span class="badge bg-primary ms-2">{{ routes | length }}</span>
        </h5>
        <div class="d-flex gap-2">
            <a href="{{ url_for('new_route_form') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Add Route
            </a>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshRoutes()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        {% if routes %}
        <div class="table-responsive">
            <table id="routes-table" class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="sortable" data-sort="source">
                            Source <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                        </th>
                        <th class="sortable" data-sort="host">
                            Host <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                        </th>
                        <th class="sortable" data-sort="upstream">
                            Upstream <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                        </th>
                        <th class="sortable" data-sort="route_id">
                            Route ID <i class="bi bi-chevron-expand sort-icon ms-1"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="routes-table-body">
                    {% for route in routes %}
                    <tr data-source="{{ route.source }}" data-host="{{ route.host }}" data-upstream="{{ route.upstream }}" data-route-id="{{ route.route_id }}">
                        <td data-label="Source">
                            {% if route.source == 'monitor' %}
                                <span class="badge bg-success" title="Auto-discovered from Docker container">
                                    <i class="bi bi-robot me-1"></i>Auto
                                </span>
                            {% else %}
                                <span class="badge bg-primary" title="Manually created route">
                                    <i class="bi bi-person-gear me-1"></i>Manual
                                </span>
                            {% endif %}
                        </td>
                        <td data-label="Host">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-globe me-2 text-primary flex-shrink-0"></i>
                                <div class="host-content" style="min-width: 0; flex: 1;">
                                    <div class="fw-semibold text-truncate" title="{{ route.host }}" style="max-width: 100%;">{{ route.host }}</div>
                                    <small class="text-muted">Index: {{ route.index }}</small>
                                </div>
                            </div>
                        </td>
                        <td data-label="Upstream">
                            <div class="d-flex align-items-center">
                                {% if route.protocol == 'https' %}
                                    <i class="bi bi-shield-lock text-success me-1 flex-shrink-0" title="HTTPS Backend"></i>
                                {% else %}
                                    <i class="bi bi-globe text-primary me-1 flex-shrink-0" title="HTTP Backend"></i>
                                {% endif %}
                                <code class="text-success text-truncate" title="{{ route.protocol.upper() }}://{{ route.upstream }}" style="max-width: 100%;">{{ route.protocol.upper() }}://{{ route.upstream }}</code>
                            </div>
                        </td>
                        <td data-label="Route ID">
                            <code class="small text-muted">{{ route.route_id }}</code>
                        </td>
                        <td data-label="Actions">
                            {% if route.source == 'monitor' %}
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-secondary" disabled title="Auto-discovered routes cannot be edited">
                                        <i class="bi bi-lock"></i>
                                    </button>
                                    <small class="text-muted ms-2">Managed by Docker Monitor</small>
                                </div>
                            {% else %}
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('edit_route_form', route_id=route.route_id) }}" 
                                       class="btn btn-sm btn-outline-primary" title="Edit Route">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            title="Delete Route"
                                            onclick="confirmDelete('{{ route.route_id }}', '{{ route.host }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="text-muted">
                <i class="bi bi-inbox display-1"></i>
                <h4 class="mt-3">No routes configured</h4>
                <p class="mb-0">Use the Add Route button above to create your first route.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to delete this route?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Host:</strong> <span id="delete-host"></span><br>
                    <strong>Route ID:</strong> <code id="delete-route-id"></code>
                </div>
                <p class="text-muted small mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" id="delete-form" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Delete Route
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if error %}
<div class="alert alert-danger mt-4">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
function confirmDelete(routeId, host) {
    document.getElementById('delete-host').textContent = host;
    document.getElementById('delete-route-id').textContent = routeId;
    document.getElementById('delete-form').action = `/routes/${routeId}/delete`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
    
    // Add loading state to delete button when form is submitted
    const deleteForm = document.getElementById('delete-form');
    const deleteBtn = deleteForm.querySelector('button[type="submit"]');
    
    deleteForm.addEventListener('submit', function(e) {
        if (deleteBtn) {
            if (window.DCRP && window.DCRP.setButtonLoading) {
                window.DCRP.setButtonLoading(deleteBtn, true);
            }
        }
    });
}

function refreshHealth() {
    const refreshBtn = document.querySelector('[onclick="refreshHealth()"]');
    const originalIcon = refreshBtn ? refreshBtn.innerHTML : '';
    
    if (refreshBtn) {
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
    }
    
    fetch('/api/health')
        .then(response => response.json())
        .then(data => {
            // Update status indicator
            const statusIndicator = document.getElementById('status-indicator');
            const badge = statusIndicator.querySelector('.badge');
            
            if (data.status === 'healthy' || data.status === 'ok') {
                badge.className = 'badge bg-success';
                badge.innerHTML = '<i class="bi bi-circle-fill me-1"></i>Online';
            } else {
                badge.className = 'badge bg-danger';
                badge.innerHTML = '<i class="bi bi-circle-fill me-1"></i>Error';
            }
            
            // Show success toast
            if (window.DCRP && window.DCRP.showToast) {
                window.DCRP.showToast('Health status refreshed', 'success');
            }
            
            // Update health card without reloading page
            updateHealthCard(data);
        })
        .catch(error => {
            console.error('Health check failed:', error);
            const statusIndicator = document.getElementById('status-indicator');
            const badge = statusIndicator.querySelector('.badge');
            badge.className = 'badge bg-danger';
            badge.innerHTML = '<i class="bi bi-circle-fill me-1"></i>Offline';
            
            // Show error toast
            if (window.DCRP && window.DCRP.showToast) {
                window.DCRP.showToast('Failed to refresh health status', 'error');
            }
        })
        .finally(() => {
            if (refreshBtn) {
                refreshBtn.classList.remove('loading');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalIcon;
            }
        });
}

function refreshRoutes() {
    const refreshBtn = document.querySelector('[onclick="refreshRoutes()"]');
    const originalIcon = refreshBtn ? refreshBtn.innerHTML : '';
    
    if (refreshBtn) {
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
    }
    
    // Show loading toast
    if (window.DCRP && window.DCRP.showToast) {
        window.DCRP.showToast('Refreshing routes...', 'info');
    }
    
    // Add a short delay to show loading state, then refresh data without page reload
    setTimeout(() => {
        refreshRoutesData();
    }, 300);
}

function updateHealthCard(healthData) {
    // Update health status badges and text
    const statusElements = document.querySelectorAll('.badge.bg-success, .badge.bg-danger, .badge.bg-warning');
    statusElements.forEach(badge => {
        // Update based on healthData structure
        const statusText = badge.nextElementSibling?.querySelector('.fw-semibold')?.textContent;
        if (statusText === 'API Server') {
            badge.className = `badge bg-${getStatusBadgeClass(healthData.status)}`;
            badge.nextElementSibling.querySelector('.text-muted').textContent = healthData.status?.charAt(0)?.toUpperCase() + healthData.status?.slice(1) || 'Unknown';
        }
    });
}

function getStatusBadgeClass(status) {
    switch(status?.toLowerCase()) {
        case 'healthy':
        case 'ok':
            return 'success';
        case 'degraded':
        case 'warning':
            return 'warning';
        case 'unhealthy':
        case 'error':
            return 'danger';
        default:
            return 'secondary';
    }
}

function refreshRoutesData() {
    fetch('/api/routes')
        .then(response => response.json())
        .then(routes => {
            updateRoutesTable(routes);
            if (window.DCRP && window.DCRP.showToast) {
                window.DCRP.showToast('Routes refreshed successfully', 'success');
            }
        })
        .catch(error => {
            console.error('Failed to refresh routes:', error);
            if (window.DCRP && window.DCRP.showToast) {
                window.DCRP.showToast('Failed to refresh routes', 'error');
            }
        });
}

function updateRoutesTable(routes) {
    const tbody = document.getElementById('routes-table-body');
    if (!tbody || !routes) return;
    
    // Store current column widths before updating
    const currentWidths = [];
    $('#routes-table thead th').each(function() {
        currentWidths.push($(this).outerWidth());
    });
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add new rows
    routes.forEach(route => {
        const row = createRouteRow(route);
        tbody.appendChild(row);
    });
    
    // Restore column widths
    $('#routes-table thead th').each(function(i) {
        if (currentWidths[i]) {
            $(this).css('width', currentWidths[i] + 'px');
        }
    });
    
    // Re-initialize column resizing handles if they were lost
    initializeColumnResizing();
}

function createRouteRow(route) {
    const row = document.createElement('tr');
    row.setAttribute('data-source', route.source);
    row.setAttribute('data-host', route.host);
    row.setAttribute('data-upstream', route.upstream);
    row.setAttribute('data-route-id', route.route_id);
    
    // Build row HTML - simplified version
    row.innerHTML = `
        <td data-label="Source">
            ${route.source === 'monitor' 
                ? '<span class="badge bg-success" title="Auto-discovered from Docker container"><i class="bi bi-robot me-1"></i>Auto</span>'
                : '<span class="badge bg-primary" title="Manually created route"><i class="bi bi-person-gear me-1"></i>Manual</span>'
            }
        </td>
        <td data-label="Host">
            <div class="d-flex align-items-center">
                <i class="bi bi-globe me-2 text-primary"></i>
                <div class="host-content">
                    <div class="fw-semibold text-truncate" title="${route.host}">${route.host}</div>
                    <small class="text-muted">Index: ${route.index}</small>
                </div>
            </div>
        </td>
        <td data-label="Upstream">
            <code class="upstream-code text-truncate" title="${route.upstream}">${route.upstream}</code>
        </td>
        <td data-label="Route ID">
            <code class="route-id-code" title="${route.route_id}">${route.route_id}</code>
        </td>
        <td data-label="Actions">
            ${route.source === 'monitor'
                ? `<div class="d-flex align-items-center">
                     <button class="btn btn-sm btn-outline-secondary" disabled title="Managed by Docker Monitor">
                       <i class="bi bi-gear"></i>
                     </button>
                     <small class="text-muted ms-2">Managed by Docker Monitor</small>
                   </div>`
                : `<div class="btn-group" role="group">
                     <a href="/routes/${route.route_id}/edit" class="btn btn-sm btn-outline-primary" title="Edit Route">
                       <i class="bi bi-pencil"></i>
                     </a>
                     <button class="btn btn-sm btn-outline-danger" title="Delete Route" onclick="confirmDelete('${route.route_id}', '${route.host}')">
                       <i class="bi bi-trash"></i>
                     </button>
                   </div>`
            }
        </td>
    `;
    
    return row;
}

// Table sorting functionality
let currentSortColumn = null;
let currentSortDirection = 'asc';

function initializeTableSorting() {
    // Add click handlers to sortable headers
    $('.sortable').on('click', function(e) {
        // Don't sort if we're clicking on a resize handle
        if ($(e.target).hasClass('resize-handle') || $(e.target).closest('.resize-handle').length > 0) {
            return;
        }
        
        const column = $(this).data('sort');
        sortTable(column);
    });
}

function sortTable(column) {
    const tbody = $('#routes-table tbody');
    const rows = tbody.find('tr').toArray();
    
    // Determine sort direction
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortDirection = 'asc';
        currentSortColumn = column;
    }
    
    // Update header icons
    $('.sort-icon').removeClass('bi-chevron-up bi-chevron-down').addClass('bi-chevron-expand');
    const $currentHeader = $(`.sortable[data-sort="${column}"] .sort-icon`);
    $currentHeader.removeClass('bi-chevron-expand');
    $currentHeader.addClass(currentSortDirection === 'asc' ? 'bi-chevron-up' : 'bi-chevron-down');
    
    // Sort rows
    rows.sort((a, b) => {
        let aVal = getSortValue($(a), column);
        let bVal = getSortValue($(b), column);
        
        // Convert to lowercase for case-insensitive sorting
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        
        let result = 0;
        if (aVal < bVal) result = -1;
        else if (aVal > bVal) result = 1;
        
        return currentSortDirection === 'desc' ? -result : result;
    });
    
    // Re-append sorted rows
    tbody.empty();
    rows.forEach(row => tbody.append(row));
    
    console.log(`Table sorted by ${column} in ${currentSortDirection} order`);
}

function getSortValue($row, column) {
    const data = $row.data();
    
    switch(column) {
        case 'source':
            return data.source;
        case 'host':
            return data.host;
        case 'upstream':
            return data.upstream;
        case 'route_id':
            return data.routeId;
        default:
            return '';
    }
}

// Auto-refresh status every 30 seconds (disabled during column resize)
let healthRefreshInterval;
function startHealthRefresh() {
    if (!healthRefreshInterval) {
        healthRefreshInterval = setInterval(() => {
            if (!isResizingColumn) { // Only refresh if not resizing
                refreshHealth();
            }
        }, 30000);
    }
}
startHealthRefresh();

// Initialize simple table functionality when document is ready
$(document).ready(function() {
    // Only initialize if the table exists
    if ($('#routes-table').length > 0) {
        // Enable Bootstrap tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();
        
        // Set table layout to fixed for better column control
        $('#routes-table').css('table-layout', 'fixed');
        
        // Set initial column widths explicitly
        $('#routes-table thead th').each(function(index) {
            const $th = $(this);
            const currentWidth = $th.outerWidth();
            $th.css('width', currentWidth + 'px');
            
            // Also set widths for body cells
            $('#routes-table tbody tr').each(function() {
                $(this).find('td').eq(index).css('width', currentWidth + 'px');
            });
        });
        
        // Initialize column resizing
        initializeColumnResizing();
        
        // Initialize table sorting
        initializeTableSorting();
    }
});

// Column resizing functionality
let isResizingColumn = false;
let resizingColumn = null;
let startX = 0;
let startWidth = 0;
let columnIndex = -1;

function initializeColumnResizing() {
    // Remove existing event listeners to avoid duplicates
    $('#routes-table thead th:not(:last-child)').off('.columnResize');
    
    // Add resize handles to column headers - each handle resizes its own column
    $('#routes-table thead th:not(:last-child)').each(function(index) {
        const $th = $(this);
        if (!$th.find('.resize-handle').length) {
            $th.css('position', 'relative');
            const $handle = $('<div class="resize-handle" style="position: absolute; right: 0; top: 0; bottom: 0; width: 6px; cursor: col-resize; z-index: 10; background: rgba(0,0,0,0.1);"></div>');
            $handle.data('target-column', index); // Store which column this handle should resize (its own column)
            $th.append($handle);
        }
    });
    
    // Initial overflow will be handled dynamically during resize
    
    // Handle resize handle mousedown
    $('#routes-table thead th .resize-handle').on('mousedown.columnResize', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Prevent sorting when dragging
        const $handle = $(this);
        const $handleColumn = $handle.parent();
        columnIndex = $handle.data('target-column'); // Use the stored target column
        
        const headers = $('#routes-table thead th');
        const $targetColumn = headers.eq(columnIndex);
        
        console.log('Resize handle clicked:', {
            handleColumnIndex: $handleColumn.index(),
            handleColumnText: $handleColumn.text().trim(),
            targetColumnIndex: columnIndex,
            targetColumnText: $targetColumn.text().trim()
        });
        
        startColumnResize($targetColumn, e);
    });
    
    // Handle cursor change on hover
    $('#routes-table thead th:not(:last-child)').on('mousemove.columnResize', function(e) {
        const rect = this.getBoundingClientRect();
        const isNearRightEdge = e.clientX > rect.right - 10;
        
        if (isNearRightEdge && !isResizingColumn) {
            $(this).css('cursor', 'col-resize');
        } else if (!isResizingColumn) {
            $(this).css('cursor', 'pointer');
        }
    });
    
    $('#routes-table thead th:not(:last-child)').on('mouseleave.columnResize', function() {
        if (!isResizingColumn) {
            $(this).css('cursor', 'pointer');
        }
    });
}

function startColumnResize($column, e) {
    console.log('startColumnResize called', { column: $column, columnIndex });
    isResizingColumn = true;
    resizingColumn = $column;
    startX = e.clientX;
    startWidth = $column.outerWidth();
    
    console.log('Starting resize of column', columnIndex, '(' + $column.text().trim() + ') with width', startWidth);
    
    // Disable any auto-refresh or updates during resize
    $('body').addClass('resizing-active');
    
    // Lock all column widths to prevent redistribution
    const $table = $('#routes-table');
    const headers = $table.find('thead th');
    
    headers.each(function(i) {
        const $header = $(this);
        const currentWidth = $header.outerWidth();
        $header.css('width', currentWidth + 'px');
        
        // Also set body cell widths
        $table.find('tbody tr').each(function() {
            $(this).find('td').eq(i).css('width', currentWidth + 'px');
        });
    });
    
    console.log('All columns locked, starting resize');
    
    // Add resizing class
    $column.addClass('resizing');
    
    // Prevent text selection and other interactions
    e.preventDefault();
    e.stopPropagation();
    
    // Disable pointer events on other elements to prevent interference
    $('.table-responsive').css('user-select', 'none');
    
    // Add global mouse event listeners
    $(document).on('mousemove.columnResize', handleColumnResize);
    $(document).on('mouseup.columnResize', stopColumnResize);
    $(window).on('blur.columnResize', stopColumnResize); // Stop if window loses focus
}

function handleColumnResize(e) {
    if (!isResizingColumn || !resizingColumn || columnIndex < 0) return;
    
    const minColumnWidth = 80;
    const diff = e.clientX - startX;
    let proposedWidth = Math.max(minColumnWidth, startWidth + diff);
    
    // Check if the new width would cause table overflow
    const container = $('#routes-table').closest('.table-responsive');
    const containerWidth = container.width();
    
    // Calculate current table width and what it would be with the new column width
    let currentTableWidth = 0;
    $('#routes-table thead th').each(function() {
        currentTableWidth += $(this).outerWidth();
    });
    
    const newTableWidth = currentTableWidth - startWidth + proposedWidth;
    
    // If the table would exceed container width, limit the proposed width
    if (newTableWidth > containerWidth) {
        const maxAllowedWidth = containerWidth - (currentTableWidth - startWidth);
        proposedWidth = Math.max(minColumnWidth, maxAllowedWidth);
        console.log('Limited column width to prevent overflow. Max allowed:', proposedWidth);
    }
    
    // Apply width to the target column header using setAttribute for stronger override
    resizingColumn[0].style.cssText = `width: ${proposedWidth}px !important; min-width: ${proposedWidth}px !important; max-width: ${proposedWidth}px !important;`;
    
    // Update the body cells for this column only
    $('#routes-table tbody tr').each(function() {
        const td = $(this).find('td').eq(columnIndex)[0];
        if (td) {
            td.style.cssText = `width: ${proposedWidth}px !important; min-width: ${proposedWidth}px !important; max-width: ${proposedWidth}px !important;`;
        }
    });
    
    // Also update colgroup if it exists, or create one
    let colgroup = $('#routes-table colgroup');
    if (colgroup.length === 0) {
        colgroup = $('<colgroup></colgroup>');
        $('#routes-table').prepend(colgroup);
        
        // Add col elements for each column
        $('#routes-table thead th').each(function() {
            colgroup.append('<col>');
        });
    }
    
    // Update the specific col element
    const cols = colgroup.find('col');
    if (cols.eq(columnIndex).length > 0) {
        cols.eq(columnIndex)[0].style.width = proposedWidth + 'px';
    }
    
    console.log('Resized column', columnIndex, 'to', proposedWidth + 'px', 'Table width:', newTableWidth, 'Container width:', containerWidth);
}

function stopColumnResize() {
    if (!isResizingColumn) return;
    
    isResizingColumn = false;
    
    console.log('Resize operation completed');
    
    // Remove resizing class
    if (resizingColumn) {
        resizingColumn.removeClass('resizing');
        resizingColumn.css('cursor', 'pointer');
    }
    $('body').removeClass('resizing-active');
    
    // Re-enable pointer events
    $('.table-responsive').css('user-select', '');
    
    // Remove global event listeners
    $(document).off('.columnResize');
    $(window).off('.columnResize');
    
    // Clean up
    resizingColumn = null;
    columnIndex = -1;
    
    console.log('Column resize cleanup completed');
}

function fixInitialTableOverflow() {
    const table = $('#routes-table');
    if (!table.length) return;
    
    const container = table.closest('.table-responsive');
    if (!container.length) return;
    
    const containerWidth = container.width();
    const headers = table.find('thead th');
    
    // Calculate current total width
    let currentTotal = 0;
    headers.each(function() { 
        currentTotal += $(this).outerWidth(); 
    });
    
    console.log('Initial table overflow check:', { 
        currentTotal, 
        containerWidth, 
        overflow: currentTotal - containerWidth
    });
    
    // If table exceeds container width, shrink columns proportionally
    if (currentTotal > containerWidth) {
        const excess = currentTotal - containerWidth;
        const minColumnWidth = 120;
        
        console.log('Fixing initial overflow, excess:', excess);
        
        // Calculate available space from all resizable columns (exclude Actions)
        let totalAvailableSpace = 0;
        let resizableColumns = [];
        
        for (let i = 0; i < headers.length - 1; i++) { // Skip Actions column
            const $header = headers.eq(i);
            const currentWidth = $header.outerWidth();
            const availableSpace = Math.max(0, currentWidth - minColumnWidth);
            totalAvailableSpace += availableSpace;
            resizableColumns.push({ index: i, $header, currentWidth, availableSpace });
        }
        
        console.log('Total available space for shrinking:', totalAvailableSpace);
        
        if (totalAvailableSpace >= excess) {
            // Distribute the excess proportionally among columns that can be shrunk
            let remainingExcess = excess;
            
            resizableColumns.forEach(function(col) {
                if (remainingExcess > 0 && col.availableSpace > 0) {
                    const proportionOfTotal = col.availableSpace / totalAvailableSpace;
                    const spaceToTake = Math.min(col.availableSpace, Math.ceil(remainingExcess * proportionOfTotal));
                    
                    if (spaceToTake > 0) {
                        const newWidth = col.currentWidth - spaceToTake;
                        col.$header.css('width', newWidth + 'px');
                        
                        console.log(`Initial shrink: column ${col.index} from ${col.currentWidth}px to ${newWidth}px`);
                        
                        // Update corresponding body cells
                        $('#routes-table tbody tr').each(function() {
                            $(this).find('td').eq(col.index).css('width', newWidth + 'px');
                        });
                        
                        remainingExcess -= spaceToTake;
                    }
                }
            });
            
            console.log('Initial overflow fixed, remaining excess:', remainingExcess);
        } else {
            console.log('Cannot fully fix initial overflow - not enough available space');
        }
    }
}

</script>

<style>
/* Table cell overflow handling */
#routes-table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 0;
    position: relative;
}

#routes-table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}

#routes-table th.sortable:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

/* Ensure icons don't shrink in flex containers */
.flex-shrink-0 {
    flex-shrink: 0 !important;
}

/* Ensure text truncation works in nested flex containers */
.host-content,
.text-truncate {
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Improved code elements for upstream URLs */
.upstream-code {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    font-size: 0.875em;
}

/* Sort icon positioning */
.sort-icon {
    font-size: 0.75em;
    opacity: 0.5;
    transition: opacity 0.2s ease;
}

#routes-table th.sortable:hover .sort-icon {
    opacity: 1;
}

/* Active sort indicators */
.sort-icon.bi-chevron-up,
.sort-icon.bi-chevron-down {
    opacity: 1;
    color: var(--bs-primary);
}

/* Column resize handle styling improvements */
.resize-handle {
    background: rgba(108, 117, 125, 0.2) !important;
    transition: background-color 0.2s ease;
}

.resize-handle:hover {
    background: rgba(108, 117, 125, 0.4) !important;
}
</style>
{% endblock %}